{% extends "base.html" %}

{% block title %}{{ _('Kayıt Ol') }} - StudyBuddy{% endblock %}

{% block content %}
<section class="page-gradient-bg">
    <div class="auth-page">
        <div class="auth-card">
            <div class="auth-logo">
                <img src="{{ url_for('static', filename='img/studybuddy-owl.png') }}" alt="StudyBuddy Logo">
                <h2>{{ _('StudyBuddy\'ye Kayıt Ol') }}</h2>
            </div>

            <form method="POST" action="{{ url_for('register') }}" id="registerForm" class="auth-form" novalidate>
                {{ csrf_token_input() }}

                <div class="floating-field">
                    <div class="floating-input-wrapper">
                        <input 
                            type="text" 
                            id="username" 
                            name="username" 
                            class="floating-input" 
                            required 
                            minlength="3" 
                            maxlength="80" 
                            autocomplete="username"
                            value="{{ request.form.get('username', '') }}">
                        <label for="username" class="floating-label">{{ _('Kullanıcı Adı') }}</label>
                    </div>
                    <small class="input-feedback" id="usernameFeedback" role="alert" aria-live="polite"></small>
                </div>

                <div class="floating-field">
                    <div class="floating-input-wrapper">
                        <input 
                            type="email" 
                            id="email" 
                            name="email" 
                            class="floating-input" 
                            required 
                            autocomplete="email"
                            value="{{ request.form.get('email', '') }}">
                        <label for="email" class="floating-label">{{ _('Email Adresi') }}</label>
                    </div>
                    <small class="input-feedback" id="emailFeedback" role="alert" aria-live="polite"></small>
                </div>

                <div class="floating-field">
                    <div class="floating-input-wrapper">
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            class="floating-input" 
                            required 
                            minlength="8" 
                            autocomplete="new-password">
                        <label for="password" class="floating-label">{{ _('Şifre') }}</label>
                        <button 
                            type="button" 
                            class="password-toggle-btn" 
                            aria-label="{{ _('Şifreyi göster') }}" 
                            aria-pressed="false" 
                            data-target="password">
                            <i class="bi bi-eye-fill"></i>
                        </button>
                    </div>
                    <div class="password-strength-bar">
                        <span id="passwordStrengthMeter"></span>
                    </div>
                    <div class="password-requirements">
                        <div class="password-requirements-title">{{ _('Şifre gereksinimleri') }}</div>
                        <ul>
                            <li data-rule="length">
                                <span class="requirement-icon invalid"><i class="bi bi-x-circle"></i></span>
                                <span>{{ _('En az 8 karakter') }}</span>
                            </li>
                            <li data-rule="uppercase">
                                <span class="requirement-icon invalid"><i class="bi bi-x-circle"></i></span>
                                <span>{{ _('En az bir büyük harf') }}</span>
                            </li>
                            <li data-rule="lowercase">
                                <span class="requirement-icon invalid"><i class="bi bi-x-circle"></i></span>
                                <span>{{ _('En az bir küçük harf') }}</span>
                            </li>
                            <li data-rule="number">
                                <span class="requirement-icon invalid"><i class="bi bi-x-circle"></i></span>
                                <span>{{ _('En az bir rakam') }}</span>
                            </li>
                            <li data-rule="symbol">
                                <span class="requirement-icon invalid"><i class="bi bi-x-circle"></i></span>
                                <span>{{ _('En az bir özel karakter') }}</span>
                            </li>
                        </ul>
                    </div>
                    <small class="input-feedback" id="passwordFeedback" role="alert" aria-live="polite"></small>
                </div>

                <div class="floating-field">
                    <div class="floating-input-wrapper">
                        <input 
                            type="password" 
                            id="password_confirm" 
                            name="password_confirm" 
                            class="floating-input" 
                            required 
                            autocomplete="new-password">
                        <label for="password_confirm" class="floating-label">{{ _('Şifre Tekrar') }}</label>
                        <button 
                            type="button" 
                            class="password-toggle-btn" 
                            aria-label="{{ _('Şifre tekrarını göster') }}" 
                            aria-pressed="false" 
                            data-target="password_confirm">
                            <i class="bi bi-eye-fill"></i>
                        </button>
                    </div>
                    <small class="input-feedback" id="passwordMatchFeedback" role="alert" aria-live="polite"></small>
                </div>

                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="terms" required>
                    <label class="form-check-label" for="terms">{{ _('Kullanım şartlarını kabul ediyorum') }}</label>
                </div>

                <button type="submit" class="btn-primary-custom w-100">
                    <i class="bi bi-person-plus"></i> {{ _('Kayıt Ol') }}
                </button>

                <div class="auth-footer">
                    <p class="mb-0">{{ _('Zaten hesabınız var mı?') }} <a href="{{ url_for('login') }}">{{ _('Giriş yapın') }}</a></p>
                </div>
            </form>
        </div>
    </div>
</section>
<span id="js-password-mismatch" style="display:none;">{{ _('Şifreler eşleşmiyor') }}</span>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const floatingInputs = document.querySelectorAll('.floating-input');
        const passwordField = document.getElementById('password');
        const confirmField = document.getElementById('password_confirm');
        const strengthMeter = document.getElementById('passwordStrengthMeter');
        const requirements = document.querySelectorAll('.password-requirements li');
        const passwordMatchFeedback = document.getElementById('passwordMatchFeedback');

        const updateFloatingState = (input) => {
            const field = input.closest('.floating-field');
            if (!field) return;
            field.classList.toggle('has-value', input.value.trim() !== '');
        };

        const refreshFloatingStates = () => {
            floatingInputs.forEach((input) => updateFloatingState(input));
        };

        floatingInputs.forEach((input) => {
            input.addEventListener('input', () => updateFloatingState(input));
            input.addEventListener('change', () => updateFloatingState(input));
            updateFloatingState(input);
        });

        setTimeout(refreshFloatingStates, 100);
        setTimeout(refreshFloatingStates, 400);
        window.addEventListener('pageshow', refreshFloatingStates);

        document.querySelectorAll('.password-toggle-btn').forEach((button) => {
            button.addEventListener('click', () => {
                const target = document.getElementById(button.dataset.target);
                if (!target) return;

                const isHidden = target.getAttribute('type') === 'password';
                target.setAttribute('type', isHidden ? 'text' : 'password');
                button.setAttribute('aria-pressed', String(isHidden));

                const icon = button.querySelector('i');
                icon.classList.toggle('bi-eye-fill', !isHidden);
                icon.classList.toggle('bi-eye-slash-fill', isHidden);

                button.classList.add('bounce');
                setTimeout(() => button.classList.remove('bounce'), 450);
            });
        });

        const ruleChecks = {
            length: (val) => val.length >= 8,
            uppercase: (val) => /[A-ZÇĞİÖŞÜ]/.test(val),
            lowercase: (val) => /[a-zçğıöşü]/.test(val),
            number: (val) => /\d/.test(val),
            symbol: (val) => /[!@#$%^&*(),.?":{}|<>]/.test(val),
        };

        const updateRequirements = () => {
            const value = passwordField.value;
            let passed = 0;

            requirements.forEach((item) => {
                const rule = item.dataset.rule;
                const icon = item.querySelector('.requirement-icon');
                const isValid = ruleChecks[rule] ? ruleChecks[rule](value) : false;

                item.classList.toggle('valid', isValid);
                icon.classList.toggle('valid', isValid);
                icon.classList.toggle('invalid', !isValid);
                icon.innerHTML = isValid 
                    ? '<i class="bi bi-check-circle-fill" aria-hidden="true"></i>'
                    : '<i class="bi bi-x-circle" aria-hidden="true"></i>';

                if (isValid) passed += 1;
            });

            strengthMeter.className = '';
            if (value.length === 0) {
                strengthMeter.style.width = '0%';
                return;
            }

            if (passed <= 2) {
                strengthMeter.classList.add('weak');
            } else if (passed <= 4) {
                strengthMeter.classList.add('medium');
            } else {
                strengthMeter.classList.add('strong');
            }
        };

        const checkPasswordMatch = () => {
            if (!confirmField.value) {
                passwordMatchFeedback.textContent = '';
                confirmField.setCustomValidity('');
                return;
            }

            if (confirmField.value !== passwordField.value) {
                const mismatchText = document.getElementById('js-password-mismatch')?.textContent || 'Şifreler eşleşmiyor';
                passwordMatchFeedback.textContent = mismatchText;
                confirmField.setCustomValidity(mismatchText);
            } else {
                passwordMatchFeedback.textContent = '';
                confirmField.setCustomValidity('');
            }
        };

        passwordField.addEventListener('input', () => {
            updateRequirements();
            checkPasswordMatch();
        });
        confirmField.addEventListener('input', checkPasswordMatch);
    });
</script>
{% endblock %}
