{% extends "base.html" %}

{% block title %}Şifre Sıfırlama - StudyBuddy{% endblock %}

{% block content %}
<section class="page-gradient-bg">
    <div class="auth-page">
        <div class="auth-card">
            <div class="auth-logo">
                <img src="{{ url_for('static', filename='img/studybuddy-owl.png') }}" alt="StudyBuddy Logo">
                <h2>Yeni Şifre Belirleyin</h2>
            </div>

            <form method="POST" action="{{ url_for('reset_password', token=token) }}" id="resetForm" class="auth-form" novalidate>
                {{ csrf_token_input() }}

                <div class="floating-field">
                    <div class="floating-input-wrapper">
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            class="floating-input" 
                            required 
                            minlength="8"
                            autocomplete="new-password">
                        <label for="password" class="floating-label">Yeni Şifre</label>
                        <button type="button" class="password-toggle-btn" aria-label="Şifreyi göster/gizle" aria-pressed="false">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    <div class="password-strength-bar" id="passwordStrength" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="4" aria-label="Şifre gücü">
                        <div class="password-strength-fill"></div>
                    </div>
                    <div class="password-requirements">
                        <ul>
                            <li id="req-length"><i class="bi bi-circle"></i> En az 8 karakter</li>
                            <li id="req-uppercase"><i class="bi bi-circle"></i> En az bir büyük harf</li>
                            <li id="req-lowercase"><i class="bi bi-circle"></i> En az bir küçük harf</li>
                            <li id="req-number"><i class="bi bi-circle"></i> En az bir rakam</li>
                        </ul>
                    </div>
                    <small class="input-feedback" id="passwordFeedback" role="alert" aria-live="polite"></small>
                </div>

                <div class="floating-field">
                    <div class="floating-input-wrapper">
                        <input 
                            type="password" 
                            id="password_confirm" 
                            name="password_confirm" 
                            class="floating-input" 
                            required
                            autocomplete="new-password">
                        <label for="password_confirm" class="floating-label">Yeni Şifre Tekrar</label>
                        <button type="button" class="password-toggle-btn" aria-label="Şifreyi göster/gizle" aria-pressed="false">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    <small class="input-feedback" id="confirmFeedback" role="alert" aria-live="polite"></small>
                </div>

                <button type="submit" class="btn-primary-custom w-100" id="submitBtn">
                    <i class="bi bi-check-circle"></i> Şifreyi Güncelle
                </button>
            </form>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const passwordInput = document.getElementById('password');
        const confirmInput = document.getElementById('password_confirm');
        const passwordField = passwordInput.closest('.floating-field');
        const confirmField = confirmInput.closest('.floating-field');
        const submitBtn = document.getElementById('submitBtn');
        
        // Floating label management
        const updateFloatingState = (input) => {
            const field = input.closest('.floating-field');
            if (input.value && input.value.trim() !== '') {
                field.classList.add('has-value');
            } else {
                field.classList.remove('has-value');
            }
        };
        
        [passwordInput, confirmInput].forEach(input => {
            input.addEventListener('input', () => updateFloatingState(input));
            input.addEventListener('change', () => updateFloatingState(input));
        });
        
        // Password toggle
        document.querySelectorAll('.password-toggle-btn').forEach((btn, index) => {
            const input = index === 0 ? passwordInput : confirmInput;
            btn.addEventListener('click', () => {
                const isPressed = btn.getAttribute('aria-pressed') === 'true';
                input.type = isPressed ? 'password' : 'text';
                btn.setAttribute('aria-pressed', !isPressed);
                btn.querySelector('i').className = isPressed ? 'bi bi-eye' : 'bi bi-eye-slash';
                btn.classList.add('bounce');
                setTimeout(() => btn.classList.remove('bounce'), 300);
            });
        });
        
        // Password strength checker
        const strengthBar = document.getElementById('passwordStrength');
        const strengthFill = strengthBar.querySelector('.password-strength-fill');
        const requirements = {
            length: document.getElementById('req-length'),
            uppercase: document.getElementById('req-uppercase'),
            lowercase: document.getElementById('req-lowercase'),
            number: document.getElementById('req-number')
        };
        
        passwordInput.addEventListener('input', () => {
            const pwd = passwordInput.value;
            let strength = 0;
            
            // Check requirements
            const checks = {
                length: pwd.length >= 8,
                uppercase: /[A-Z]/.test(pwd),
                lowercase: /[a-z]/.test(pwd),
                number: /\d/.test(pwd)
            };
            
            Object.keys(checks).forEach(key => {
                if (checks[key]) {
                    requirements[key].querySelector('i').className = 'bi bi-check-circle-fill';
                    requirements[key].classList.add('met');
                    strength++;
                } else {
                    requirements[key].querySelector('i').className = 'bi bi-circle';
                    requirements[key].classList.remove('met');
                }
            });
            
            // Update strength bar
            strengthBar.setAttribute('aria-valuenow', strength);
            strengthFill.style.width = (strength * 25) + '%';
            strengthBar.className = 'password-strength-bar';
            if (strength <= 1) {
                strengthBar.classList.add('weak');
            } else if (strength <= 2) {
                strengthBar.classList.add('medium');
            } else if (strength <= 3) {
                strengthBar.classList.add('good');
            } else {
                strengthBar.classList.add('strong');
            }
            
            updateFloatingState(passwordInput);
            checkPasswordMatch();
        });
        
        // Password match checker
        const checkPasswordMatch = () => {
            const confirmFeedback = document.getElementById('confirmFeedback');
            if (confirmInput.value) {
                if (passwordInput.value !== confirmInput.value) {
                    confirmFeedback.textContent = 'Şifreler eşleşmiyor';
                    confirmField.classList.add('error');
                    confirmInput.setCustomValidity('Şifreler eşleşmiyor');
                } else {
                    confirmFeedback.textContent = '';
                    confirmField.classList.remove('error');
                    confirmInput.setCustomValidity('');
                }
            } else {
                confirmFeedback.textContent = '';
                confirmField.classList.remove('error');
                confirmInput.setCustomValidity('');
            }
        };
        
        confirmInput.addEventListener('input', () => {
            updateFloatingState(confirmInput);
            checkPasswordMatch();
        });
        
        // Autofill handling
        setTimeout(() => {
            [passwordInput, confirmInput].forEach(updateFloatingState);
        }, 50);
        
        window.addEventListener('pageshow', () => {
            [passwordInput, confirmInput].forEach(updateFloatingState);
        });
    });
</script>
{% endblock %}
